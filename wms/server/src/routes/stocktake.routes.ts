import { Router } from 'express';
import { z } from 'zod';
import * as controller from '../controllers/stocktake.controller.js';
import { auth } from '../middlewares/auth.js';
import { requireRole } from '../middlewares/rbac.js';
import { validate } from '../middlewares/validate.js';
import { objectIdSchema } from '@wms/shared/schemas';

const router = Router();

const itemSchema = z.object({
  productId: objectIdSchema,
  locationId: objectIdSchema,
  systemQty: z.number().nonnegative().optional(),
  countedQty: z.number().nonnegative()
});

const createSchema = z.object({
  code: z.string().min(1),
  date: z.coerce.date(),
  items: z.array(itemSchema).min(1),
  minutes: z.string().optional(),
  attachments: z.array(z.string()).optional()
});

const updateSchema = z.object({
  date: z.coerce.date().optional(),
  items: z.array(itemSchema).optional(),
  minutes: z.string().optional(),
  attachments: z.array(z.string()).optional()
});

const approveSchema = z.object({
  minutes: z.string().optional(),
  attachments: z.array(z.string()).optional()
}).default({});

router.use(auth);

router.get('/', controller.list);
router.post('/', requireRole('Staff', 'Manager', 'Admin'), validate({ body: createSchema }), controller.create);
router.put('/:id', requireRole('Staff', 'Manager', 'Admin'), validate({ body: updateSchema }), controller.update);
router.post(
  '/:id/approve',
  requireRole('Manager', 'Admin'),
  validate({ body: approveSchema }),
  controller.approve
);
router.post('/:id/apply', requireRole('Manager', 'Admin'), controller.apply);

export default router;
